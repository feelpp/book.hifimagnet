[[user_manual]]
= {hifimagnet} user manual
:toc: macro
include::{partialsdir}/header-macros.adoc[]
include::{partialsdir}/header-uri.adoc[]
include::{partialsdir}/mso4sc-uri.adoc[]

Welcome to {hifimagnet} manual documentation!

NOTE: The {hifimagnet} manual documentation introduces the process to build and run an application.
New user shall read the xref:ROOT:index.adoc[{hifimagnet} introduction] to have a global view.

IMPORTANT: You wish to contribute? Please consult the xref:ROOT:index.adoc#contribute[contribute] section to learn how to proceed!

[[introduction]]
= Introduction to {hifimagnet}

.Discuss and Contribute
TIP: Use {uri-feelpp-issues}/858[Issue 858] to drive development of this
section. Your contributions make a difference. No contribution is too small.

= What is {hifimagnet}?

{hifimagnet} is a software chain that allows to design and model High Field Magnets.
It consists in a set of tools including:

* {magnettools}
* {hifimagnet}
** cad tools: {uri-gmsh-www}[gmsh], {uri-salome-www}[{salome}]
** meshing: {uri-gmsh-www}[gmsh], {uri-netgen-www}[netgen], {uri-meshgems-www}[{meshgems}]
** multiphics models: {feelpp} toolboxes
** post-processing: {uri-ensight-www}[EnSight], {uri-paraview-www}[ParaView]

When using containers, note that the tools are distributed into 3 differents containers:

* one for pre-processing (see xref:cad:index.adoc#qs_getting[here]),
* one for running simulations (see respectively here for xref:magnettools:index.adoc#qs_installation[Axi] and here for xref:user:index.adoc#qs_installation[3D]),
* one for post-processing (see xref:post:index.adoc[here]).

[TIP]
====
link:{uri-ensight-www}[EnSight (recommended)]:: is a commercial multi-platform data analysis and visualization application.
link:{uri-paraview-www}[ParaView]:: is an open-source, multi-platform data analysis and visualization application.
link:https://wci.llnl.gov/simulation/computer-codes/visit[Visit]:: is a distributed, parallel visualization and graphical analysis tool for data defined on two- and three-dimensional (2D and 3D) meshes
====

[[quickstart]]
= Quick Starts


[[qs_installation]]
== Getting {hifimagnet}


Using {hifimagnet} inside container, either Docker or Singularity based,
is the recommended and fastest way. If your system support singularity containers we recommend to use them instead of Docker ones.


[[singularity]]
=== from sregistry

To get the {hifimagnet} singularity image you need first to get you token on a valid sregistry:

* connect to the {sregistry}Â service (eg link:https://sregistry.srv.cesga.es/[cesga sregistry] use the {fiware} authentification}
* in the top right scrolling menu with your user id, select *Token*
* copy the line to a `.sregistry` in your home directory

The {hifimagnet} singularity images are stored in a private collection.
To download the images you have to be granted access to the {hifimagnet} team.
Once this is done, from a terminal:

[source,csh]
----
export SREGISTRY_CLIENT=registry
export SREGISTRY_CLIENT_SECRETS=~/.sregistry-cesga
[export SREGISTRY_STORAGE=...]

sregistry pull --name hifimagnet-stretch.simg hifimagnet/hifimagnet:stretch
----


[[dockerhub]]
=== from dockerhub

You need to be member of {feelpp} team on link:https://hub.docker.com/[dockerhub] to be able to download the image.
To get the image:

[source,csh]
----
docker login
docker pull feelpp/hifimagnet
----

Check the existing docker images on link:https://hub.docker.com/r/feelpp/salome/[feelpp/hifimagnet dockerhub]

=== Install from {lncmi} Debian repository

On Debian/Ubuntu system you can install {hifimagnet} from the local {lncmi} packages repository.
To do so:

* you need to have access to the {lncmi} repository
* add a lncmi.lst into your `/etc/apt/sources.list.d` directory:

[source,txt]
.`lncmi.lst` for Debian Testing distribution
----
deb http://euler/~trophime/debian/ testing main 
deb-src http://euler/~trophime/debian/ testing main 
----

Then run:

[source,csh]
----
sudo apt update
sudo apt install hifimagnet
----

[NOTE]
====
Supported Debian/Ubuntu distributions:

* Stretch
* Xenial

On Windows 10 Pro you can also install {hifimagnet} without much effort.
Just enable WSL feature and download Debian Stretch or Ubuntu Xenial (aka 16.04 LST)
from Microsoft App Store. Then apply the same procedure as above to install the package.
====

// === Install from scratch

[[qs_usage]]
== Running {hifimagnet}


=== from Singularity container

Assuming we use `hifimagnet.simg` singularity image:

[source,sh]
----
singularity run -it -v $HOME/feel:/feel feelpp/hifimagnet feelpp_hfm_coupledmodel_3DP1N1 --config  ...
----

The `coupled_3D_P1_N1_singular_cvg.cfg` configuration file holds all the information
to specify what calculations are performed. The configuration files are fully described in this <<data, section>>

=== from Docker container

Start the Docker container `feelpp/hifimagnet` as follows

[source,sh]
----
docker run -it -v $HOME/feel:/feel feelpp/hifimagnet feelpp_hfm_coupledmodel_3DP1N1 --config  ...
----

=== from command line

To perform a 3D fully coupled multi-physics simulation:

[source,sh]
----
feelpp_hfm_coupledmodel_3DP1N1 --config coupled_3D_P1_N1_singular_cvg.cfg
----

[[usage]]
= Using {hifimagnet}

As stated in introduction {hifimagnet} per se provides tools to simulation High Field Magnets.
More precisely we can model:

* thermo-electric behavior,
* magnetic field produced:
** everywhere
** only in a zone of interest from a user perspective
* mechanical behavior accounting for:
** an axisymetrical estimation of the magnetic field
** the magnetic field produced
** thermal dilation
* fully coupled behavior

The kind of calculation performed is specified in a configuration `cfg` file.
The data settings consist in writting json files for each physical model involved,
providing connection between CAD/Mesh entities to respectively Material and Boundary conditions.

[[data]]
== Data structure

{hifimagnet} simulations parameters are defined througth configuration file `.cfg`
and `json` files defining the model per physic and eventually some other `json` files
for the physical properties of the materials. 

The data structure follows {feelpp} style and convention.
In this section we will give details about these different files.

=== Config Files

[source,cfg]
----
include::{examplesdir}/coupled_3D_P1_N1_singular_cvg.cfg[]
----
<1> name of the geometry or mesh
<2> gmsh options: scale (optional, the default is *meter*), mesh size
<3> list of conductor and insulator volumes
<4> flag to control calculations
<5> thermo-electric model
<6> elasticity model
<8> magnetostatic model
<7> specific to {hifimagnet}

The first lines define the geometry or mesh to consider:

* name of the geometry or mesh
* gmsh options: scale (optional, the default is *meter*), mesh size
* list of conductor and insulator volumes

The next section give setup the calculations to be ran:


This is followed by section dedicated to specific physics.
In this example we have:

* thermo-electric model
* elasticity model
* magnetostatic model

Each of this physic section contains:

* name of the `json` file holding the complete description of the model (see bellow),
* setup of the solver: eg `[electro]` and [`thermal`] for thermo-electric model

Solver are specific to each physical model.
However in general, the default solver is a direct solver.
For large problems, we would prefer iterative solver for efficiency.
A typical iterative solver is defined as follow:

* `pc-type`: name of the preconditionner,
* `ksp-rtol`: relative tolerance to stop iterative solver,
* `ksp-atol`: absolute tolerance to stop iterative solver,
* `ksp-maxit`: maximum iterations allowed to reach convergence,
* `ksp-use-initial-guess-nonzero`: enable to start with a non null initial guess solution.

Section `magnetic_field-bmap` is specific to {hifimagnet}. It enables to define
data needed to compute the "ideal" magnetic field provided by a magnet
using xref:xref:magnettools:Bmap.adoc#bmap[]:

* the `.d` cfg file describing the Axisymetrical model of the magnet
* the values for the input currents in each subsets of the magnet

[NOTE]
====
A magnet is composed of PolyHelices insert and eventually some external magnets either
Bitter magnets and/or Supraconductor Magnets. 
====

=== Physic Model files

The Physic Model files are `json` files that contain informations about:

* Materials
* Boundary Conditions
* Post-Processing quantities

==== ThermoElctric Model file

[source,cfg]
----
include::{examplesdir}/quarter-torus3D-therm.json[]
----

==== Magnetostatics Model file

[source,cfg]
----
include::{examplesdir}/quarter-torus3D-mag.json[]
----

==== Elasticity Model file

[source,cfg]
----
include::{examplesdir}/quarter-torus3D-elasticity.json[]
----

=== Materials file

Physical properties of the material are defined in a `json` file
for each material. The properties are given in SI units.

[source,cfg]
----
include::{examplesdir}/Cu.json[]
----

In the table bellow, you will find the correspondance between an entrie in the `json` file
defining properties for material <1> :

|===
^|Notation             ^|Quantity                            ^|Unit                     ^|Note
^| <2> stem:[\alpha]   ^| thermal resistivity coefficient    ^|-                         |
^| <3> stem:[\sigma]   ^| electrical conductivity            ^|stem:[S.m^{-1}]          ^| an expression of stem:[T] 
 |                      |                                     |                         ^| (references values,indiced with a stem:[_0], at stem:[T_0]) 
^| <4> stem:[k]        ^| thermal conductivity               ^|stem:[W.m^{-1} .K^{-1}]  ^| same
^| <5> stem:[Y]        ^| Young modulus                      ^|stem:[Pa]                 |
^| <6> stem:[\nu]      ^| Poisson ratio                      ^|-                         |
^| <7> stem:[\alpha_T] ^| thermal expansion coefficient      ^|stem:[K^{-1}]             |
^| <8> stem:[\rho]     ^| material's density                 ^|stem:[kg.m^{-3}]          |
^| <9> stem:[\mu]      ^| magnetic permeability              ^|stem:[V.s.A^{-1}.m^{-1}]  |
|===

== Workflow
=== Using {magnettools} to define Design

* create optimized axi geometry
* run `opt2yml` to create the cfg files for {hifimagnet} {salome} Plugin

=== Using {hifimagnet} {salome} Plugin to create CAD and generate meshes

* fill in the missing data into {salome} yaml cfg files
* run the CAD generation
* eventually add `Air`
* mesh
* improve the mesh

=== Prepare the mesh for HPC

The mesh created with {hifimagnet} {salome} is in `med` format.
Depending on the version of {feelpp} used this format may not be supported.
So before running any simulation you have to convert the mesh to `gmsh V2` format:

[source,sh]
----
gmsh -bin -3 mesh.med -o mesh.msh
----

Then you have eventually to partition the mesh to use it on HPC:

[source,sh]
----
feelpp_mesh_partitioner [--gmsh.scale=0.001] --ifile mesh.msh -ofile mesh-np4 --part 4 --nochdir
----

where `part` denotes the number of processors (4 in our example) you want to use.
The option `--gmsh.scale=0.001` enables to rescale the mesh file.

This will create new files `mesh-np4.json` and `mesh-np4.h5` ready for running.

[NOTE]
=====
{hifimagnet}Â {salome} CAD geometries are defined in `mm`.
The mesh file generated is also in `mm`. 

As a consequence, **do not forget to rescale the mesh** before running simulation.
Use `--gmsh.scale=0.001` to rescale the mesh.
=====

=== Define Cfg, Model and Materials files
=== Running 3D simulations
=== Postprocessing results

== Examples

* xref:benchmarks:HL/README.adoc[HL] 
* xref:benchmarks:HL-31/README.adoc[HL-31]

